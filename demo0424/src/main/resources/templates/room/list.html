<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{main}"> <!-- Assuming a main layout template -->
<head>
    <title>Room List</title>
</head>
<body>
<div layout:fragment="content">
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1>Rooms</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a th:href="@{/}">Home</a></li>
                        <li class="breadcrumb-item active">Room List</li>
                    </ol>
                </div>
            </div>
        </div><!-- /.container-fluid -->
    </section>

    <section class="content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">All Rooms</h3>
                            <div class="card-tools">
                                <a id="addRoomButton" th:href="@{/rooms/add}" class="btn btn-primary">
                                    <i class="fas fa-plus"></i> Add Room
                                </a>
                            </div>
                        </div>
                        <!-- /.card-header -->
                        <div class="card-body">
                            <table id="roomsTable" class="table table-bordered table-hover">
                                <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Room Number</th>
                                    <th>Dormitory ID/Name</th> <!-- Placeholder for name -->
                                    <th>Capacity</th>
                                    <th>Occupancy</th>
                                    <th>Gender Type</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="room : ${rooms}">
                                    <td th:text="${room.id}">1</td>
                                    <td th:text="${room.roomNumber}">A101</td>
                                    <!-- Attempt to display dormitory name if available, else ID -->
                                    <td th:text="${room.dormitory?.name ?: room.dormitoryId}">Dormitory Name / ID</td>
                                    <td th:text="${room.capacity}">4</td>
                                    <td th:text="${room.currentOccupancy}">0</td>
                                    <td th:text="${room.genderType}">ANY</td>
                                    <td>
                                        <a th:href="@{/rooms/edit/{id}(id=${room.id})}" class="btn btn-sm btn-info editRoomButton">
                                            <i class="fas fa-edit"></i> Edit
                                        </a>
                                        <a th:href="@{/rooms/delete/{id}(id=${room.id})}"
                                           class="btn btn-sm btn-danger"
                                           onclick="return confirm('Are you sure you want to delete this room?');">
                                            <i class="fas fa-trash"></i> Delete
                                        </a>
                                    </td>
                                </tr>
                                <tr th:if="${#lists.isEmpty(rooms)}">
                                    <td colspan="7" class="text-center">No rooms found.</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <!-- /.card-body -->
                    </div>
                    <!-- /.card -->
                </div>
            </div>
        </div>
    </section>

    <!-- Modal Placeholder -->
    <div class="modal fade" id="roomModal" tabindex="-1" role="dialog" aria-labelledby="roomModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>

</div>

<th:block layout:fragment="scripts">
    <script th:inline="javascript">
        $(document).ready(function () {
            // --- Add Room Modal ---
            $('#addRoomButton').on('click', function (e) {
                e.preventDefault();
                var url = $(this).attr('href');
                loadRoomModalContent(url);
            });

            // --- Edit Room Modal ---
            $('#roomsTable').on('click', '.editRoomButton', function(e) {
                e.preventDefault();
                var url = $(this).attr('href');
                loadRoomModalContent(url);
            });

            function loadRoomModalContent(url) {
                var $modal = $('#roomModal');
                var $modalContent = $modal.find('.modal-content');

                $modalContent.html(''); // Clear previous content
                $modalContent.html('<div class="modal-body text-center"><div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div><p>Loading form...</p></div>');
                $modal.modal('show');

                // Expecting room/form.html to have a div with id="roomFormContent"
                $modalContent.load(url + ' #roomFormContent', function(response, status, xhr) {
                    if (status == "error") {
                        var errorTitle = 'Error Loading Room Form';
                        var errorBody = '<p>Sorry, an error occurred while loading the room form. Please try again later.</p>';
                        if (xhr.status !== 0) {
                           errorBody += '<p>Error: ' + xhr.status + ' ' + xhr.statusText + '</p>';
                        }
                        showRoomModalError($modal, errorTitle, errorBody);
                    } else {
                        setupRoomModalFormSubmitHandler($modal);
                        // Initialize any plugins like select2 if used in the loaded form
                        if ($.fn.select2) {
                           $modal.find('select').select2({ theme: 'bootstrap4' });
                        }
                    }
                });
            }

            function setupRoomModalFormSubmitHandler($modal) {
                var $form = $modal.find('form');
                if (!$form.length) return;

                $form.off('submit').on('submit', function(e) {
                    e.preventDefault();
                    var form = $(this);
                    var url = form.attr('action');
                    var $submitButton = form.find('button[type="submit"]');
                    var originalButtonText = $submitButton.html();
                    $submitButton.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...').prop('disabled', true);

                    $.ajax({
                        type: "POST",
                        url: url,
                        data: form.serialize(),
                        success: function(response, status, xhr) {
                            $modal.modal('hide');
                            location.reload();
                        },
                        error: function(xhr, status, error) {
                            $submitButton.html(originalButtonText).prop('disabled', false);
                            if (xhr.responseText && xhr.responseText.includes('<form')) {
                                var $errorResponse = $(xhr.responseText);
                                var $errorFormContent = $errorResponse.find('#roomFormContent');
                                if ($errorFormContent.length) {
                                    $modal.find('.modal-content').html($errorFormContent.html());
                                } else {
                                     // Fallback if specific content not found in error response
                                    $modal.find('.modal-content').html(xhr.responseText);
                                }
                                setupRoomModalFormSubmitHandler($modal); // Re-attach for the new/updated form
                                // Re-initialize plugins if needed
                                if ($.fn.select2) {
                                   $modal.find('select').select2({ theme: 'bootstrap4' });
                                }
                            } else {
                                var errorTitle = 'Error Saving Room';
                                var errorBody = '<p>An error occurred while saving. Please check your input and try again.</p>';
                                if (xhr.responseText && xhr.status !== 0) {
                                     var detail = xhr.responseText;
                                     try { varjsonResponse = JSON.parse(detail); if (jsonResponse.message) detail = jsonResponse.message; } catch (e) { /* not json */ }
                                    errorBody += '<p>Details: ' + ( (detail.length > 200) ? detail.substring(0,200) + "..." : detail )+ '</p>';
                                }
                                showRoomModalError($modal, errorTitle, errorBody);
                            }
                        }
                    });
                });

                // Handle "Cancel" button if it's not using data-dismiss="modal"
                // For room/form.html, we will change it to use data-dismiss="modal"
                // $form.find('a.btn-secondary').on('click', function(e) {
                // e.preventDefault();
                // $modal.modal('hide');
                // });
            }

            function showRoomModalError($modal, title, body) {
                var $modalContent = $modal.find('.modal-content');
                $modalContent.html(
                    '<div class="modal-header"><h5 class="modal-title">' + title + '</h5><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>' +
                    '<div class="modal-body">' + body + '</div>' +
                    '<div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button></div>'
                );
            }
        });
    </script>
</th:block>

</body>
</html>
