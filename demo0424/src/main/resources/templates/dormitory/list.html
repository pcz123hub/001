<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{main}"> <!-- Assuming a main layout template -->
<head>
    <title>Dormitory List</title>
</head>
<body>
<div layout:fragment="content">
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1>Dormitories</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="#">Home</a></li>
                        <li class="breadcrumb-item active">Dormitory List</li>
                    </ol>
                </div>
            </div>
        </div><!-- /.container-fluid -->
    </section>

    <section class="content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">All Dormitories</h3>
                            <div class="card-tools">
                                <a id="addDormitoryButton" th:href="@{/dormitories/add}" class="btn btn-primary" data-toggle="modal" data-target="#dormitoryModal-OBSOLETE-BUT-KEEP-FOR-NOW">
                                    <i class="fas fa-plus"></i> Add Dormitory
                                </a>
                            </div>
                        </div>
                        <!-- /.card-header -->
                        <div class="card-body">
                            <table id="dormitoriesTable" class="table table-bordered table-hover">
                                <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Address</th>
                                    <th>Total Rooms</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="dorm : ${dormitories}">
                                    <td th:text="${dorm.id}">1</td>
                                    <td th:text="${dorm.name}">Dorm Name</td>
                                    <td th:text="${dorm.address}">Dorm Address</td>
                                    <td th:text="${dorm.totalRooms}">100</td>
                                    <td>
                                        <a th:href="@{/dormitories/edit/{id}(id=${dorm.id})}" class="btn btn-sm btn-info">
                                            <i class="fas fa-edit"></i> Edit
                                        </a>
                                        <a th:href="@{/dormitories/delete/{id}(id=${dorm.id})}"
                                           class="btn btn-sm btn-danger"
                                           onclick="return confirm('Are you sure you want to delete this dormitory?');">
                                            <i class="fas fa-trash"></i> Delete
                                        </a>
                                    </td>
                                </tr>
                                <tr th:if="${#lists.isEmpty(dormitories)}">
                                    <td colspan="5" class="text-center">No dormitories found.</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <!-- /.card-body -->
                    </div>
                    <!-- /.card -->
                </div>
            </div>
        </div>
    </section>

    <!-- Modal Placeholder -->
    <div class="modal fade" id="dormitoryModal" tabindex="-1" role="dialog" aria-labelledby="dormitoryModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document"> <!-- modal-lg for a wider modal -->
            <div class="modal-content">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>

</div>

<th:block layout:fragment="scripts">
    <script th:inline="javascript">
        $(document).ready(function () {
            // --- Add Dormitory Modal ---
            $('#addDormitoryButton').on('click', function (e) {
                e.preventDefault();
                var url = $(this).attr('href');
                loadModalContent(url);
            });

            // --- Edit Dormitory Modal ---
            // Attach to a common parent for dynamically added content if table is ever reloaded via AJAX
            $('#dormitoriesTable').on('click', '.editDormitoryButton', function(e) {
                e.preventDefault();
                var url = $(this).attr('href');
                loadModalContent(url);
            });
            
            function loadModalContent(url) {
                var $modal = $('#dormitoryModal');
                var $modalContent = $modal.find('.modal-content');

                $modalContent.html(''); // Clear previous content
                // Add a loading spinner
                $modalContent.html('<div class="modal-body text-center"><div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div><p>Loading form...</p></div>');
                $modal.modal('show');

                // Load only the specific fragment from the form page
                $modalContent.load(url + ' #dormitoryFormContent', function(response, status, xhr) {
                    if (status == "error") {
                        var errorTitle = 'Error Loading Form';
                        var errorBody = '<p>Sorry, an error occurred while loading the form. Please try again later.</p>';
                        if (xhr.status !== 0) { // if it's not a CORS or network error, show details
                           errorBody += '<p>Error: ' + xhr.status + ' ' + xhr.statusText + '</p>';
                        }
                        showModalError($modal, errorTitle, errorBody);
                    } else {
                        // Form loaded successfully, setup submit handler for it
                        setupModalFormSubmitHandler($modal);
                    }
                });
            }

            function setupModalFormSubmitHandler($modal) {
                var $form = $modal.find('form'); // Assuming one form in the loaded content
                if (!$form.length) return;

                // Remove any existing submit handler to prevent multiple bindings
                $form.off('submit'); 
                
                $form.on('submit', function(e) {
                    e.preventDefault();
                    var form = $(this);
                    var url = form.attr('action');

                    // Optional: Add a loading state to the submit button
                    var $submitButton = form.find('button[type="submit"]');
                    var originalButtonText = $submitButton.html();
                    $submitButton.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...').prop('disabled', true);

                    $.ajax({
                        type: "POST",
                        url: url,
                        data: form.serialize(),
                        success: function(response, status, xhr) {
                            // Check if the response is likely a redirect (full HTML page) or specific success fragment/JSON
                            // For this setup, we assume successful save means reload the main page.
                            $modal.modal('hide');
                            location.reload(); 
                        },
                        error: function(xhr, status, error) {
                            $submitButton.html(originalButtonText).prop('disabled', false);
                            // Attempt to replace the modal content with the form + errors
                            // This assumes the server returns the form with error messages on validation failure
                            if (xhr.responseText && xhr.responseText.includes('<form')) {
                                // If server returns error, it might be the full page. We need to extract the form part again.
                                var $errorResponse = $(xhr.responseText);
                                var $errorFormContent = $errorResponse.find('#dormitoryFormContent');
                                if ($errorFormContent.length) {
                                    $modal.find('.modal-content').html($errorFormContent.html());
                                } else {
                                    // Fallback if specific content not found in error response
                                    $modal.find('.modal-content').html(xhr.responseText);
                                }
                                // Re-attach handler for the new form content
                                setupModalFormSubmitHandler($modal); 
                            } else {
                                // Generic error display if the response is not the form
                                var errorTitle = 'Error Saving Dormitory';
                                var errorBody = '<p>An error occurred while saving. Please check your input and try again.</p>';
                                if (xhr.responseText && xhr.status !== 0) {
                                     var detail = xhr.responseText;
                                     // Attempt to parse if it's JSON, otherwise show as text
                                     try {
                                         varjsonResponse = JSON.parse(detail);
                                         if (jsonResponse.message) detail = jsonResponse.message;
                                         // You could extract more structured error info here if your server sends it
                                     } catch (e) { /* not json */ }
                                    errorBody += '<p>Details: ' + ( (detail.length > 200) ? detail.substring(0,200) + "..." : detail )+ '</p>';
                                }
                                // When showing a generic error, the form might be gone.
                                // The "Try Again" button in this context is tricky.
                                // Simplest is to let them close and re-open the modal.
                                showModalError($modal, errorTitle, errorBody, false);
                            }
                        }
                    });
                });

                // Ensure cancel buttons inside the loaded modal content are handled
                // This needs to be done after content is loaded, so ideally inside setupModalFormSubmitHandler
                // or if the cancel button has a simple data-dismiss="modal", Bootstrap handles it.
                // If it's a link styled as a button, it might need specific handling if it's not data-dismiss.
                // The current form.html cancel button is an <a> tag. Let's ensure it closes the modal.
                var $cancelButton = $form.find('a.btn-secondary'); // Find cancel button
                $cancelButton.on('click', function(e) {
                    e.preventDefault();
                    $modal.modal('hide');
                });
            }

            function showModalError($modal, title, body, showTryAgainButtonIfApplicable, tryAgainCallback) {
                // This function is simplified as "Try Again" logic can be complex
                // if it needs to restore specific state.
                var $modalContent = $modal.find('.modal-content');
                var footerButtons = '<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>';
                // Example: if (showTryAgainButtonIfApplicable && tryAgainCallback) { footerButtons = ... }

                $modalContent.html(
                    '<div class="modal-header"><h5 class="modal-title">' + title + '</h5><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>' +
                    '<div class="modal-body">' + body + '</div>' +
                    '<div class="modal-footer">' + footerButtons + '</div>'
                );
                 // $modal.modal('show'); // Already shown or will be shown by caller.
            }

        });
    </script>
</th:block>

</body>
</html>
